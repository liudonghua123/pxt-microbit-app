var DisconnectResponse;!function(e){e[e.Disconnected=0]="Disconnected",e[e.Waiting=1]="Waiting",e[e.TimedOut=2]="TimedOut"}(DisconnectResponse||(DisconnectResponse={}));const ref="@relprefix@".replace("---","").replace(/^\//,""),pageUrl="@targetUrl@/"+ref,refCacheName="makecode;"+ref+";@pxtRelId@";function initWebappServiceWorker(){const e=-1===ref.indexOf("/"),t=[pageUrl,"@simUrl@","/pxt-microbit-app/semantic.js","/pxt-microbit-app/main.js","/pxt-microbit-app/pxtapp.js","/pxt-microbit-app/typescript.js","/pxt-microbit-app/marked/marked.min.js","/pxt-microbit-app/highlight.js/highlight.pack.js","/pxt-microbit-app/jquery.js","/pxt-microbit-app/pxtlib.js","/pxt-microbit-app/pxtcompiler.js","/pxt-microbit-app/pxtpy.js","/pxt-microbit-app/pxteditor.js","/pxt-microbit-app/pxtsim.js","/pxt-microbit-app/pxtembed.js","/pxt-microbit-app/pxtworker.js","/pxt-microbit-app/pxtweb.js","/pxt-microbit-app/blockly.css","/pxt-microbit-app/semantic.css","/pxt-microbit-app/rtlsemantic.css","/pxt-microbit-app/blockly/media/sprites.png","/pxt-microbit-app/blockly/media/click.mp3","/pxt-microbit-app/blockly/media/disconnect.wav","/pxt-microbit-app/blockly/media/delete.mp3","/pxt-microbit-app/vs/loader.js","/pxt-microbit-app/vs/base/worker/workerMain.js","/pxt-microbit-app/vs/basic-languages/bat/bat.js","/pxt-microbit-app/vs/basic-languages/cpp/cpp.js","/pxt-microbit-app/vs/basic-languages/python/python.js","/pxt-microbit-app/vs/basic-languages/markdown/markdown.js","/pxt-microbit-app/vs/editor/editor.main.css","/pxt-microbit-app/vs/editor/editor.main.js","/pxt-microbit-app/vs/editor/editor.main.nls.js","/pxt-microbit-app/vs/language/json/jsonMode.js","/pxt-microbit-app/vs/language/json/jsonWorker.js","/pxt-microbit-app/smoothie/smoothie_compressed.js","/pxt-microbit-app/images/Bars_black.gif","/pxt-microbit-app/gifjs/gif.js","/pxt-microbit-app/ai.2.min.js","/pxt-microbit-app/target.js","/pxt-microbit-app/music-editor/apple.png","/pxt-microbit-app/music-editor/burger.png","/pxt-microbit-app/music-editor/cake.png","/pxt-microbit-app/music-editor/car.png","/pxt-microbit-app/music-editor/cat.png","/pxt-microbit-app/music-editor/cherry.png","/pxt-microbit-app/music-editor/clam.png","/pxt-microbit-app/music-editor/computer.png","/pxt-microbit-app/music-editor/crab.png","/pxt-microbit-app/music-editor/dog.png","/pxt-microbit-app/music-editor/duck.png","/pxt-microbit-app/music-editor/egg.png","/pxt-microbit-app/music-editor/explosion.png","/pxt-microbit-app/music-editor/fish.png","/pxt-microbit-app/music-editor/ice-cream.png","/pxt-microbit-app/music-editor/lemon.png","/pxt-microbit-app/music-editor/snake.png","/pxt-microbit-app/music-editor/star.png","/pxt-microbit-app/music-editor/strawberry.png","/pxt-microbit-app/music-editor/taco.png","/pxt-microbit-app/music-editor/bass-clef.svg","/pxt-microbit-app/music-editor/treble-clef.svg","/pxt-microbit-app/fieldeditors.js","/pxt-microbit-app/editor.js","","@targetUrl@/pxt-microbit-app/monacoworker.js","@targetUrl@/pxt-microbit-app/worker.js"],o=r(""),i=r("%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Fproviders%2Fgithub-mark.png;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Fproviders%2Fmicrosoft-logo.svg;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Fproviders%2Fgoogle-logo.svg;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Fproviders%2Fclever-logo.png;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Flogo.portrait.white.svg;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Flogo.square.white.svg;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Flogo.portrait.black.svg;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Ficons%2Fapple-touch-icon.png;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2FMicrosoft_logo_rgb_W-white_D-square.png;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2FMicrosoft_logo_rgb_W-white_D.png;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Fherogallery%2Fhero-banner.png;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Fdownload%2Ftransfer.png;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Fdownload%2Fconnect-microbit.gif;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Fdownload%2Ffull-reset.gif;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Fdownload%2Fselecting-microbit.gif;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Fdownload%2Fsuccessfully-paired.png;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Fdownload%2Fincompatible.png;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Fdownload%2Fdevice-forgotten.gif;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Fdownload%2Fbrowser-unpair-image.gif;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Fwinapp.PNG;%2Fpxt-microbit-app%2Fdocs%2Fstatic%2Fprofile%2Fmicrobit-cloud.png"),n=s(t.concat(i).map((e=>e.trim())).filter((e=>!!e&&0!==e.indexOf("@"))));let c=!1;function s(e){const t=[];for(const o of e)-1===t.indexOf(o)&&t.push(o);return t}function r(e){const t=String.fromCharCode(64)+"cdnUrl"+String.fromCharCode(64);return s(e.split(";").map((e=>decodeURIComponent(e).replace(t,"@cdnUrl@").trim())))}self.addEventListener("install",(t=>{e?(c=!0,console.log("Installing service worker..."),t.waitUntil(caches.open(refCacheName).then((e=>(console.log("Opened cache"),console.log("Caching:\n"+n.join("\n")),e.addAll(n).then((()=>e))))).then((e=>e.addAll(o).catch((e=>{console.log("Failed to cache hexfiles")})))).then((()=>self.skipWaiting())))):console.log("Skipping service worker install for unnamed endpoint")})),self.addEventListener("activate",(t=>{e?(console.log("Activating service worker..."),t.waitUntil(caches.keys().then((e=>{const t=e.filter((e=>{const t=function(e){const t=e.split(";");return 3!==t.length?null:t[1]}(e);return null===t||t===ref&&e!==refCacheName}));return Promise.all(t.map((e=>caches.delete(e))))})).then((()=>c?(c=!1,function(){const e=self;return e.clients.claim().then((()=>e.clients.matchAll())).then((e=>{e.forEach((e=>e.postMessage({type:"serviceworker",state:"activated",ref:ref})))}))}()):Promise.resolve())))):console.log("Skipping service worker activate for unnamed endpoint")})),self.addEventListener("fetch",(e=>{e.respondWith(async function(e){if(e.request.url.startsWith(pageUrl)){let t=e.request.url.slice(pageUrl.length);if(t.startsWith("/")&&(t=t.slice(1)),"?"===t.charAt(0)){let t;try{t=await fetch(e.request);(await caches.open(refCacheName)).put(e.request,t.clone())}catch(e){}if(t)return t;console.warn(`Unable to fetch ${e.request.url}, falling back to cache`)}}const t=await caches.match(e.request);if(t)return t;return fetch(e.request)}(e))}))}function initWebUSB(){let e,t,o,i,n=0,c="idle";async function s(e){(await self.clients.matchAll()).forEach((t=>t.postMessage(e)))}function r(){let t;const i=new Promise((t=>{console.log("Waiting for disconnect "+e),o=t,s({type:"serviceworker",action:"packet-io-lock-disconnect",lock:e})})),n=new Promise((o=>{t=setTimeout((()=>{console.log("Timed-out disconnect request "+e),o(DisconnectResponse.TimedOut)}),5e3)}));return Promise.race([i,n]).then((e=>(clearTimeout(t),o=void 0,e)))}function l(e){return new Promise((t=>{setTimeout(t,e)}))}self.addEventListener("message",(async a=>{const b=a.data;if("serviceworkerclient"===(null==b?void 0:b.type))if("request-packet-io-lock"===b.action){if(e||(e=await function(){if(e)return Promise.resolve(e);let t;const o=new Promise((e=>{console.log("check for existing lock"),i=e,s({type:"serviceworker",action:"packet-io-status"})})),n=new Promise((e=>{t=setTimeout((()=>{console.log("Timed-out check for existing lock"),e(void 0)}),1e3)}));return Promise.race([o,n]).then((e=>(clearTimeout(t),i=void 0,e)))}()),"granting"===c)return void await s({type:"serviceworker",action:"packet-io-lock-granted",granted:!1,lock:b.lock});console.log("Received lock request "+b.lock);const o=Date.now()-n;if(t=b.lock,o<4e3&&(c="waiting",console.log("Waiting to grant lock request "+b.lock),await l(4e3-o)),t!==b.lock)return console.log("Rejecting old lock request "+b.lock),void await s({type:"serviceworker",action:"packet-io-lock-granted",granted:!1,lock:b.lock});if(c="granting",e){let e;do{console.log("Sending disconnect request "+b.lock),e=await r(),e===DisconnectResponse.Waiting&&(console.log("Waiting on disconnect request "+b.lock),await l(1e3))}while(e===DisconnectResponse.Waiting)}console.log("Granted lock request "+b.lock),e=b.lock,await s({type:"serviceworker",action:"packet-io-lock-granted",granted:!0,lock:b.lock}),n=Date.now(),c="idle"}else"release-packet-io-lock"===b.action?(console.log("Received disconnect for "+e),e=void 0,o&&o(DisconnectResponse.Disconnected)):"packet-io-lock-disconnect"===b.action?(console.log("Received disconnect response for "+e),b.didDisconnect&&(e=void 0),o&&o(b.didDisconnect?DisconnectResponse.Disconnected:DisconnectResponse.Waiting)):"packet-io-supported"===b.action?await s({type:"serviceworker",action:"packet-io-supported",supported:!0}):"packet-io-status"===b.action&&b.hasLock&&i&&i(b.lock)}))}initWebappServiceWorker(),initWebUSB();